---
layout: post
published: true
title:  k8sä¹‹dnsä¸€æ¢ç©¶ç«Ÿ
categories: [ k8s ]
tags: [ tcpdump æŠ“åŒ… ç½‘ç»œ]
---
* content
{:toc}



# å‰è¨€
å¯¹äºk8s dnsçš„æ•…éšœæ’æŸ¥ï¼Œè‡ªå·±æ„Ÿè§‰å·²ç»æœ‰ç‚¹å¿ƒå¾—äº†ï¼Œå¤§éƒ¨ä»½æ„Ÿè§‰å·²ç»æœ‰äº†ä¸€ä¸ªå¥—è·¯ï¼Œä½†æ˜¯æœ€è¿‘ç¿»äº†äº†ä¸€æ¬¡è½¦ï¼Œçªç„¶æ„Ÿè§‰ä¸å¥æ•ˆäº†ã€‚å…¶å®æ¯ä¸ªç¿»è½¦çš„èƒŒåï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€äº›çŸ¥è¯†ç‚¹ä¸è¶³çš„è¡¨ç°ï¼Œå¦‚æœå½“æ—¶åªæ˜¯æŠŠè¿™æ¬¡ç¿»è½¦å½“ä½œå¶ç„¶å› ç´ ï¼Œä»»å…¶ä¸€é—ªè€Œè¿‡ï¼Œé‚£ä¹ˆè¿™äº›çŸ¥è¯†ç‚¹çš„ç›²åŒºå°±ä¼šä¸€ç›´æˆä¸ºâ€œéšè”½çš„è§’è½â€ã€‚

# ç¯å¢ƒ

æœ¬æ¬¡å®éªŒï¼Œç”¨çš„æ˜¯kså®‰è£…çš„ç¯å¢ƒï¼Œä¸¤ä¸»ä¸¤ä»ã€‚

```
[root@node1 ~]# kubectl get nodes -o wide
NAME    STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
node1   Ready    master,worker   13d   v1.17.6   192.168.0.2   <none>        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.12
node2   Ready    master,worker   13d   v1.17.6   192.168.0.3   <none>        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.12
node3   Ready    worker          13d   v1.17.6   192.168.0.4   <none>        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.12
node4   Ready    worker          13d   v1.17.6   192.168.0.5   <none>        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.12
```

svc ip pool :  10.233.0.0/18  
pod ip pool : 10.233.64.0/18  
cni: calico  

coredns service ip: 10.233.0.3  
coredns pod ip: 10.233.74.65  10.233.71.1

```
[root@node1 ~]# kubectl -n kube-system get po -l k8s-app=kube-dns -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
coredns-79c6f6447f-6f9xp   1/1     Running   0          13d   10.233.74.65   node4   <none>           <none>
coredns-79c6f6447f-hp7ng   1/1     Running   0          13d   10.233.71.1    node3   <none>           <none>
```

# ä¸€èˆ¬äººæŸ¥dnsçš„å¤„ç†æ–¹æ³•
å¯¹äºæŸ¥dnså¾ˆå¤šäººéƒ½å–œæ¬¢æ–°åˆ›å»ºä¸ªå®¹å™¨ï¼Œç„¶ååœ¨å®¹å™¨é‡Œé¢å»PingæŸä¸ªåŸŸåï¼Œæˆ‘åˆšå¼€å§‹ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼Œä½†æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼š

è¿™ä¸ªå‘½ä»¤æœ‰æ—¶ç»å¸¸æ•²é”™ï¼Œå› ä¸ºæœ‰é‚£ä¹ˆé•¿ä¸²ï¼Œç„¶åè¿˜ä¾èµ–ç½‘ç»œï¼Œå®¹å™¨ä¸‹è½½å®Œåï¼Œpingä¸‹dnsçš„åŸŸåå°±å®Œäº‹äº†ã€‚

ç„¶åå°±å–œæ¬¢è¿›åˆ°è´Ÿè½½podä¸­å»ï¼ŒpingæŸä¸ªåŸŸåï¼Œæˆ–æ˜¯curlæŸä¸€ç‰¹å®šçš„æœåŠ¡ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸ªå®¹å™¨ä¸­æ²¡æœ‰ping/curlå‘½ä»¤å°±GGäº†ã€‚

å¦‚ï¼š

1. ä½¿ç”¨alpineé•œåƒ
åœ¨å®¹å™¨ä¸­æ‰§è¡Œç±»ä¼¼äº curl çš„è¯·æ±‚ï¼Œæ¥è®¿é—®æŸä¸ªæœåŠ¡ï¼›æˆ–æ˜¯ç›´æ¥PingæŸä¸ªåŸŸåã€‚

æˆ‘çš„é•œåƒé‡Œé¢è£…äº†curl åŠ bind-utilsï¼Œä½ ä¹Ÿå¯ä»¥ç”¨å®˜æ–¹çš„alpineï¼Œç„¶å`apk add curl`  `apk addbind-utils`

```
kubectl --rm --restart=Never run -i -t --image=zackzhangkai/alpine console /bin/sh
kubernetes# wget -O - -q http://hello-world:8080/
```

è¿™ä¸ªæ–¹æ³•è¦ä¸‹è½½é•œåƒï¼Œè¿˜è¦æ‰§è¡Œä¸ªå‘½ä»¤è¿›å…¥å®¹å™¨ï¼Œéº»çƒ¦ï¼


2. ä½¿ç”¨busyboxé•œåƒ
é•œåƒbusyboxå°è£…äº†å¤§é‡è¿™ç§nslookup/digè¿™äº›å‘½ä»¤ï¼Œç¼ºé™·æ˜¯æ²¡æœ‰curlï¼Œè·Ÿä¸Šé¢çš„ç±»ä¼¼


3. ä½¿ç”¨nslookup

```
# å¯ä»¥ç”¨nslookupè¿™ä¸ªå‘½ä»¤æ ¹æ®ipåæŸ¥dns
nslookup 10.233.0.3
3.0.233.10.in-addr.arpa name = coredns.kube-system.svc.cluster.local.
# ä¹Ÿå¯ä»¥ç”¨dig +x åˆ°è¾¾åŒæ ·çš„æ•ˆæœ
/ # dig -x 10.233.0.3
;; ANSWER SECTION:
3.0.233.10.in-addr.arpa. 30     IN      PTR     coredns.kube-system.svc.cluster.local.
;; Query time: 1 msec
;; SERVER: 169.254.25.10#53(169.254.25.10)
# å®¹å™¨ä¸­ä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œè¿™ä¸ªï¼Œå®ƒçš„è§£æå‡ºæ¥çš„æ˜¯10.233.0.1ã€‚å®ƒåé¢æ²¡æœ‰åŠ .svc.cluster.localï¼ŒåŸå› ä¸º
# æ˜¯åŒä¸€ä¸ªnamespaceä¸‹çš„ã€‚
nslookup kubernetes.default
```

æ„Ÿè§‰nslookupæ˜¯ä¸ªå¼±é¸¡ï¼Œä¸æƒ³ç”¨ï¼Œç¨å¾®å¤æ‚ç‚¹å°±å¤„ç†ä¸äº†ï¼Œè²Œä¼¼nslooupä¹Ÿå¯ä»¥æŒ‡å®šåŸŸåæœåŠ¡å™¨ã€‚å› ä¸ºå‡¡æ˜¯nslooupèƒ½å¤Ÿè§£å†³çš„ï¼Œdigéƒ½èƒ½è§£å†³ã€‚
```
root@master1:~# nslookup 10.233.0.1 10.233.0.3
1.0.233.10.in-addr.arpa name = kubernetes.default.svc.cluster.local.
```

# ç»ˆæè§£å†³æ–¹æ³•

é¦–å…ˆdigå¤§æ³•å¥½ï¼Œå¦‚æœæ²¡æœ‰è£…å°±è£…ä¸‹ï¼š

```
yum install bind-utils -y
apk install bind-utils -y
apt-get install bind-utils -y #æ²¡æœ‰è¯•ï¼ŒçŒœçš„
```

1) ç”¨ptræ¥æŸ¥ï¼š(æœ€ç®€å•çš„)

```
root@node1:/root # dig -x 10.233.0.1 @10.233.0.3
1.0.233.10.in-addr.arpa. 30	IN	PTR	kubernetes.default.svc.cluster.local.
```
æ³¨æ„ï¼šå¦‚æœdnsè¿™ä¸ªè§£æå¤±è´¥ï¼Œå°±ç”¨corednsçš„podæ¥ç›´æ¥è§£æï¼Œä¸Šé¢è¿™ä¸ªç”¨çš„æ˜¯corednsçš„svcçš„ipæ¥è§£æï¼Œç”¨svc
ipæ¥è§£æï¼Œæœ¬è´¨ä¸Šæœ€ç»ˆä¹Ÿä¼šèµ°å‘pod ipã€‚

2) å¦‚æœç”¨pod ipæˆåŠŸï¼Œç”¨svc ipå¤±è´¥ï¼Œå°±å¯ä»¥çœ‹ä¸‹corednsçš„metricsæ¥çœ‹ä¸‹çŠ¶æ€ã€‚curl 10.233.0.3:9153/metricsæˆ–æ˜¯
ç›´æ¥ç”¨pod ipåŠ 9153ç«¯å£ã€‚å¦‚æœè¿™ä¸ªå¤±è´¥ï¼Œå¯ä»¥ç”¨`ipvsadm -lnc | grep 9153`çœ‹åŒ…çš„çŠ¶æ€ï¼ˆestablishè¡¨ç¤ºè¿æ¥æˆåŠŸï¼Œsync_sendæˆ–æ˜¯wait_recvï¼‰ã€‚

çœ‹åŒ…çš„çŠ¶æ€ï¼Œå…¶å®å¯ä»¥ç”¨`conntrack -L | grep 9153`æ¥ç›´æ¥çœ‹ï¼Œæ›´ç›´æ¥ã€‚å¦‚æœè¿™ä¸ªä¹Ÿå¤±è´¥ï¼Œå°±å¯ä»¥å¼€å§‹æŠ“è¿™ä¸ªç«¯å£çš„åŒ…ã€‚ï¼ˆè¿™ä¸ªçš„æ€è·¯æ˜¯æŠŠé—®é¢˜å¼•å‘httpæˆ–æ˜¯tcpä¸­ã€‚
æœ‰æ˜ç¡®çš„ç«¯å£å·å°±å¥½è§£å†³äº†ï¼Œå› ä¸ºå¯ä»¥ç”¨æŠ“åŒ…æ¥çœ‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥dnsæ¥æŠ“åŒ…ï¼Œä½†è¿™æ ·çš„åŒ…å¤ªå¤šä¸å¥½è¿‡æ»¤ä¹Ÿä¸å¥½å®šä½ã€‚ï¼‰  
å¯¹äºflannelï¼Œè¿˜éœ€è¦æŠ“flannel.1è¿™ä¸ªç½‘å¡ä¸Š9153ç«¯å£çš„åŒ…ã€‚å¦‚æœç”¨çš„vxlanï¼Œè¿˜éœ€è¦æŠ“eth0çš„8472ç«¯å£çš„åŒ…ï¼ˆè¿™ä¸ªæ˜¯vxlançš„udpçš„ç›®çš„ç«¯å£ï¼Œé—®é¢˜vxlançš„udpçš„é»˜è®¤
ç«¯å£æ˜¯4789ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥ç¡®å®šå®ƒçš„ç›®çš„ç«¯å£ï¼Ÿip -d link show flannl.1å¯ä»¥çœ‹åˆ°ï¼‰ã€‚  

>å› ä¸ºcorednsæœ¬è´¨ä¸Šæ˜¯æä¾›äº†metricsçš„ã€‚
>```
>[root@node1 ~]# kubectl -n kube-system get svc coredns
>NAME      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
>coredns   ClusterIP   10.233.0.3   <none>        53/UDP,53/TCP,9153/TCP   13d
>```  

3) æœ€åï¼Œå¦‚æœåªæ˜¯åœ¨å…¶ä¸­ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œäº†æ­¥éª¤1çš„æ–¹æ³•æˆåŠŸï¼Œè€Œç°åœ¨æƒ³çŸ¥é“ï¼Œåœ¨è¿™ä¸ªPodé‡Œé¢åˆ°åº•èƒ½ä¸èƒ½æ­£ç¡®è§£ææˆåŠŸï¼Ÿé‚£å°±å¯ä»¥ä½¿ç”¨nsenterè¿™ä¸ªå‘½ä»¤ï¼š
```
# æ³¨æ„ï¼šå¦‚æœç”¨nsenter,å¯¹äºdnséœ€è¦æŒ‡æ˜è§£æçš„serverï¼Œå¦åˆ™ç”¨çš„æ˜¯nodeçš„/etc/resolve.confã€‚å°±ä¼šæœ‰é—®é¢˜
nsenter -n -t 15620 dig  kubernetes.default.svc.cluster.local  # è¿™æ ·æœ‰é—®é¢˜
nsenter -n -t 15620 dig @10.233.0.3 kubernetes.default.svc.cluster.local  # è¿™ä¸ªæ­£å¸¸
nsenter -n -t 15620 dig  @10.233.0.3 -x 10.233.0.1  # digç›´æ¥ç”¨IP, pträ¹Ÿå¯ä»¥æŸ¥åˆ°ï¼Œ-xåé¢ä¸€å®šè¦ç´§è·Ÿnameserver ipã€‚
# nsenter -n -t 15620 dig -x @10.233.0.3 10.233.0.1 # è¿™ä¸ªå°±æœ‰é—®é¢˜
nsenter -n -t 31654 dig -x 10.233.0.1 @10.233.0.3 #è¿™ä¸ªæ˜¯æ­£å¸¸çš„ã€‚
# nsenterä¸€å®šè¦æ³¨æ„ï¼Œç”¨çš„ç½‘ç»œæ˜¯namespaceçš„ï¼Œä½†æ˜¯æ–‡ä»¶æ˜¯æœ¬çš„ï¼ˆåŒ…æ‹¬é…ç½®æ–‡ä»¶ï¼‰ã€‚
```

ç°åœ¨æŠ“åŒ…çœ‹ä¸‹

```
[root@node1 ~]# tcpdump -i any port 9153 -nnc 6 -w 01.pcap
```

ç„¶åè®¿é—®9153ç«¯å£

```
[root@node1 ~]# curl 10.233.71.35:9153/metrics
```

ç„¶åçœ‹ä¸‹è¿™è¿™ä¸ªåŒ…ï¼š

```
[root@node1 ~]# tcpdump -r 01.pcap
reading from file 01.pcap, link-type LINUX_SLL (Linux cooked)
10:22:23.272221 IP node1.56174 > 10.233.71.1.9153: Flags [S], seq 4036166206, win 43690, options [mss 65495,sackOK,TS val 1829192312 ecr 0,nop,wscale 7], length 0
10:22:23.272719 IP 10.233.71.1.9153 > node1.56174: Flags [S.], seq 2263089655, ack 4036166207, win 27760, options [mss 1400,sackOK,TS val 1827969692 ecr 1829192312,nop,wscale 7], length 0
10:22:23.272757 IP node1.56174 > 10.233.71.1.9153: Flags [.], ack 1, win 342, options [nop,nop,TS val 1829192313 ecr 1827969692], length 0
10:22:23.272800 IP node1.56174 > 10.233.71.1.9153: Flags [P.], seq 1:87, ack 1, win 342, options [nop,nop,TS val 1829192313 ecr 1827969692], length 86
10:22:23.272990 IP 10.233.71.1.9153 > node1.56174: Flags [.], ack 87, win 217, options [nop,nop,TS val 1827969693 ecr 1829192313], length 0
10:22:23.274020 IP 10.233.71.1.9153 > node1.56174: Flags [.], seq 1:2777, ack 87, win 217, options [nop,nop,TS val 1827969694 ecr 1829192313], length 2776
```

åˆ†æä¸‹è¿™ä¸ªåŒ…ï¼Œçœ‹ä¸‹flagï¼Œ [S]è¡¨ç¤º req  , [S.] è¡¨ç¤º req+ack, [.] è¡¨ç¤ºack ã€‚è¿™ä¸ªå°±æ˜¯tcpçš„ä¸‰æ¬¡æ¡æ‰‹ã€‚  [P.]è¡¨ç¤ºpushï¼Œæ­¤æ—¶ä¸‰æ¬¡è¿æ¥æˆåŠŸåï¼Œå°±æ˜¯httpä¼ è¾“æ•°æ®ã€‚

æŠŠå®ƒscpåˆ°æœ¬åœ°åï¼Œç”¨wiresharkæ‰“å¼€ã€‚

```
ssh root@node1 cat /root/01.pcap > /tmp/01.pcap && hugo@zack:/Users/hugo $ open /Applications/Wireshark.app /tmp/01.pcap
```

![](/styles/images/wiresharkCoredns.jpg)


corednsåªæ˜¯ä¸ªkube-systemä¸‹çš„deployï¼Œå¦‚æœæ‰€æœ‰çš„å‰¯æœ¬podsåˆ†å¸ƒåœ¨äº†ä¸€ä¸ªnodeä¸Šï¼Œç„¶åè¿™ä¸ªnodeæŒ‚äº†ï¼Œè¿™ä¸ªå°±å®¹æ˜“å‡ºé—®é¢˜äº†ï¼Œå½“ç„¶åå¾ˆå¿«ä¼šæ–°å»ºPodsï¼Œåªä¸è¿‡æœ‰ä¸ªæ•…éšœæ—¶é—´ã€‚

# å…³äºnodeLocalDns
å®ƒä¸»è¦æ˜¯ç¼“å­˜dnsè®°å½•ç”¨ï¼Œè¿‡æœŸæ—¶é—´ä¸º30s(æˆåŠŸæ—¶)ï¼Œåœ¨configmapé‡Œé¢æœ‰corefileèƒ½æŸ¥ã€‚åœ¨æ¯ä¸ªnodeä¸Šæœ‰daemonSetã€‚cluster.localçš„dnsè§£æç”¨çš„æ˜¯coreDnsï¼Œå…¶ä½™çš„ç”¨çš„æ˜¯nodeLocalDnsè‡ªå·±çš„é…ç½®ï¼Œå¯ä»cmä¸­æ¥é…ç½®ã€‚

```
root@node3:~# kubectl -n kube-system get cm nodelocaldns  -o yaml
...
Corefile: |
    cluster.local:53 {  # è¿™ä¸ªåŒ¹é… cluster.localåŸŸ
        errors
        cache {
            success 9984 30
            denial 9984 5
        }
        reload
        loop
				# kubectl -n kube-system describe po nodelocaldns-2chf7 | grep -i ip -C 3
				# Args:
				#      -localip
				#      169.254.25.10
				# root     31545 31511  0 Jun18 ?        01:21:59 /node-cache -localip 169.254.25.10 -conf /etc/coredns/Corefile -upstreamsvc coredns
        
				bind 169.254.25.10 # nodeLocalDnsçš„åœ°å€ ï¼Œ æ„æ€æ˜¯ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œç»‘å®šè¿™ä¸ªIP


        forward . 10.233.0.3 {  # é…ç½®è½¬å‘åˆ°coreDns
            force_tcp  # dnsçš„ç«¯å£æ˜¯53ï¼Œæ—¢å¯ä»¥ç”¨tcpä¹Ÿå¯ä»¥ç”¨udpã€‚è¿™é‡ŒæŒ‡æ˜å¼ºåˆ¶ä½¿ç”¨tcp  k get svc -A | grep dns  53/UDP,53/TCP
        }
        prometheus :9253
        health 169.254.25.10:9254  
    }
    in-addr.arpa:53 { # è¿™ä¸ªæŸ¥ptrè®°å½• åå‘åŸŸï¼šarpa
        errors
        cache 30
        reload
        loop
        bind 169.254.25.10
        forward . 10.233.0.3 {
            force_tcp   
        }
        prometheus :9253
    }
    ip6.arpa:53 { 
        errors
        cache 30
        reload
        loop
        bind 169.254.25.10
        forward . 10.233.0.3 {
            force_tcp
        }
        prometheus :9253
    }
		.:53 {  # å…¶ä½™çš„ä»é…ç½®æ–‡ä»¶ä¸­çš„è§„åˆ™è½¬å‘
		        errors
		        cache 30
		        reload
		        loop
		        bind 169.254.25.10
		        forward . /etc/resolv.conf
		        prometheus :9253
		    }
```

å¦‚æœåœ¨nodeä¸Šåˆ›å»ºä¸€ä¸ªPodï¼Œé»˜è®¤å®ƒçš„dnsçš„é…ç½®å¦‚ä¸‹ï¼š

```
root@node2:~# kubectl run --rm -ti --restart=Never console --image zackzhangkai/alpine -- /bin/sh
If you don't see a command prompt, try pressing enter.
/ # cat /etc/resolv.conf
nameserver 169.254.25.10 # æŒ‡å‘nodelocaldns
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5

root@node2:~# kubectl -n kube-system exec nodelocaldns-2chf7 -- cat /etc/resolv.conf
# nodelocaldns dnsé…ç½®æ–‡ä»¶
nameserver 100.64.11.3  # è¿™ä¸ªæ˜¯zoneçš„å†…ç½‘dns
nameserver 114.114.114.114 #å…¬ç½‘çš„dns 114dns.com å—äº¬ä¿¡é£
nameserver 119.29.29.29  # è¿™ä¸ªæ˜¯è…¾è®¯dns
```

æœ‰ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼šåŒæ ·æ˜¯åœ¨coredns podé‡Œé¢æ‰§è¡Œäº†catå‘½ä»¤ï¼ŒæŠ¥é”™
```
root@node2:~# kubectl -n kube-system exec coredns-878d96d96-fg6px -- cat /etc/resolv.conf
OCI runtime exec failed: exec failed: container_linux.go:349: starting container process caused "exec: \"cat\": executable file not found in $PATH": unknown
```
ä¸å¯¹ï¼Œnodelocaldnså¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯corednsé‡Œé¢æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ã€‚

é€šè¿‡æŠŠpodæ‰¾åˆ°containerID,å»ç›¸åº”çš„nodeä¸Šé€šè¿‡æŠŠdocker cpæŠŠå®ƒæ‹·å¤‡å‡ºæ¥çœ‹ä¸‹

```
root@node3:~# cat resolv.conf
nameserver 100.64.11.3
nameserver 114.114.114.114
nameserver 119.29.29.29
```
ç«Ÿç„¶è·Ÿnodelocaldnsæ˜¯ä¸€æ ·çš„ã€‚ã€‚ã€‚

é‚£æ˜¯ä»€ä¹ˆæ—¶å€™æŒ‡å®šè¿™ä¸ªæ–‡ä»¶çš„å‘¢ï¼Ÿ

çœ‹kubelete, kubeleteæ˜¯è´Ÿè´£åˆ›å»ºå®¹å™¨çš„ï¼Œçœ‹ä¸‹é‡Œé¢æ˜¯ä¸æ˜¯æœ‰æŒ‡å®šã€‚ä¹Ÿä¸ä¸€å®šæ˜¯è¿™ä¸ªåœ°æ–¹ã€‚
```
... /usr/local/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=cgroupfs --network-plugin=cni --pod-infra-container-image=kubesphere/pause:3.2 --resolv-conf=/run/systemd/resolve/resolv.conf
```
å¯ä»¥çœ‹åˆ°é‡Œé¢ç¡®å®æŒ‡å®šäº†ã€‚
```
root@node3:~# cat /run/systemd/resolve/resolv.conf
nameserver 100.64.11.3
nameserver 114.114.114.114
nameserver 119.29.29.29
# Too many DNS servers configured, the following entries may be ignored.
nameserver 1.2.4.8
```

æ­¤æ—¶æ¶‰åŠåˆ°kubeletçš„å¯åŠ¨å‚æ•°ã€‚å…¶å®è¿™ä¸ªå‚æ•°æ§åˆ¶çš„æ˜¯dnsPolicyçš„ç­–ç•¥( Default/None/ClusterFirst)ã€‚

å¦‚æœ Pod çš„ dnsPolicy è®¾ç½®ä¸º "default"ï¼Œåˆ™å®ƒå°†ä» Pod è¿è¡Œæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„é…ç½®ä¸­ç»§æ‰¿åç§°è§£æé…ç½®ã€‚

Pod çš„ DNS è§£æåº”è¯¥ä¸èŠ‚ç‚¹ç›¸åŒã€‚å¦‚æœæ‚¨ä¸æƒ³è¿™æ ·åšï¼Œæˆ–è€…æƒ³è¦ä¸º Pod ä½¿ç”¨å…¶ä»– DNS é…ç½®ï¼Œåˆ™å¯ä»¥ ä½¿ç”¨ kubelet çš„ --resolv-conf æ ‡å¿—ã€‚ å°†æ­¤æ ‡å¿—è®¾ç½®ä¸º "" ä»¥é¿å… Pod ç»§æ‰¿ DNS

æœ‰ç‚¹å¥‡æ€ªçš„æ˜¯  podçš„ipè·Ÿnodeçš„ipä¸€æ ·
å¯¹äºä¸€ä¸ªpodï¼Œå¦‚æœè¿™ä¸¤ä¸ªIpä¸€æ ·ï¼Œä¸€èˆ¬æ˜¯å®ƒçš„hostnetwork=trueè®¾ç½®çš„ï¼ŒåŸå› æ˜¯
è¿™ä¸ªå‚æ•°çš„æ„æ€å°±æ˜¯è¯´è®©podä½¿ç”¨nodeçš„ipï¼Œå¯ä»¥ç†è§£ä¸ºå®ƒä»¬ä½¿ç”¨åŒä¸€å¼ ç½‘å¡ã€‚æ­¤æ—¶éœ€è¦ä¿è¯çš„æ˜¯
è¿™ä¸ªPodé‡Œé¢çš„è¿›ç¨‹çš„ç«¯å£å¦‚æœæš´éœ²å‡ºæ¥çš„è¯ï¼Œä¸èƒ½è·ŸNodeä¸Šçš„ç«¯å£å†²çªã€‚

```
root@node3:~# kubectl -n kube-system get po nodelocaldns-2chf7 -o yaml | less -i
hostIP: 192.168.0.2  #node3çš„ipä¸0.2ï¼Œè€Œæ˜¯0.7 ï¼Œä¸å¯¹ï¼Œè¿™ä¸ªpodæœ¬æ¥å°±æ˜¯è·‘åœ¨192.168.0.2ä¸Šçš„ã€‚
  phase: Running
  podIP: 192.168.0.2
  podIPs:
  - ip: 192.168.0.2
```

## å…³äºPOD çš„ DnsPolicy

- Default: ç”¨çš„Nodeçš„/etc/resolv.coné…ç½®ï¼Œå¯ä»¥é€šè¿‡kubeletå¯åŠ¨å‘½ä»¤æ—¶åŠ  `--resolv-conf`æ¥æŒ‡å®špodé‡Œé¢çš„/etc/resov.confæ–‡ä»¶ï¼Œæ­¤æ—¶é€šè¿‡è¿™ä¸ªæ–‡ä»¶æ¥è§£æã€‚
- Noneï¼š ä»dnsConfigé‡Œé¢æ¥è¯»å–é…ç½®ï¼Œè¿™ä¸ªæš‚æ—¶è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚ 
- ClusterFirstï¼šcluster.localçš„åŸŸç”¨corednsæ¥è§£æï¼›å¦åˆ™ï¼Œå†ç”¨ä¸Šæ¸¸upstreamçš„dnsé…ç½®ï¼Œå³nodeLocalDnsçš„ï¼Œå¯ä»¥é€šè¿‡kubeletå¯åŠ¨æ—¶æŒ‡å®š `--cluster-dns`  æ¥æŒ‡å®šã€‚
- ClusterFirstWithHostNetï¼š ä¸€èˆ¬å¯¹daemonSetçš„æœ‰ç”¨ 

# è®°å½•&å¾…è§£å†³ï¼š

1ï¼‰ æˆ‘ä»¬çŸ¥é“ CNAME(æœ¬è´¨å°±æ˜¯å¦ä¸€ä¸ªåŸŸåçš„åˆ«å) ã€ Aè®°å½•ï¼ˆï¼‰ã€ AAAAè®°å½•ï¼ˆï¼‰ã€ PTRè®°å½•ï¼ˆç”±IPæ‰¾åŸŸåï¼‰ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯SRVè®°å½•ï¼Ÿ

2) å¯¹äºheadlessçš„svcï¼Œå¦‚ä½•è§£æï¼Ÿ

```
spec:
  clusterIP: None
  ports:
```

å¦‚æœä¸€ä¸ªServiceçš„spec.clusterIPæ˜¯Noneï¼Œåˆ™æ˜¯headlessã€‚

```
[root@node1 ~]# kubectl -n kubesphere-system get svc redis-ha
NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)              AGE
redis-ha   ClusterIP   None         <none>        6379/TCP,26379/TCP   13d
```

å¯¹äºheadlessçš„serviceï¼Œå®ƒçš„åŸŸåä¸ºredis-ha.kubesphere-system.svc.cluster.localï¼Œå®ƒçš„ipä¸ºä¸€ç»„podçš„ip
```
[root@node1 ~]# dig redis-ha.kubesphere-system.svc.cluster.local @10.233.0.3
redis-ha.kubesphere-system.svc.cluster.local. 30 IN A 10.233.102.133
redis-ha.kubesphere-system.svc.cluster.local. 30 IN A 10.233.74.71
redis-ha.kubesphere-system.svc.cluster.local. 30 IN A 10.233.75.4
```
å¦‚æœç°åœ¨ç”¨è¿™ä¸ªheadless serviceçš„åŸŸåï¼Œå®ƒä¼šè½®å·¡ä½¿ç”¨åç«¯çš„åœ°å€ã€‚

```
[root@node1 ~]# dig -x 10.233.102.133 @10.233.0.3
133.102.233.10.in-addr.arpa. 30 IN      PTR     10-233-102-133.redis-ha-announce-1.kubesphere-system.svc.cluster.local.
```

>é€šè¿‡è¿™ä¸ªæˆ‘ä»¬çŸ¥é“åŸŸåè·ŸIPå¹¶ä¸æ˜¯ç»å¯¹çš„ä¸€ä¸€å¯¹åº”çš„ï¼Œå¯¹æ­£å¸¸çš„serviceå®ç”¨ï¼Œä½†æ˜¯å¯¹headlessæ— å¤´serviceå°±ä¸å®ç”¨ã€‚

å¯ä»¥çœ‹åˆ°ä½¿ç”¨headless serviceæœ€å¤§çš„å¥½å¤„å°±æ˜¯ï¼šè¯¥serviceæ²¡æœ‰clusterIPï¼ŒæŸ¥è¯¢è¿™ä¸ªserviceNameï¼Œå¯ä»¥ç›´æ¥è¿”å›çœŸå®çš„åç«¯ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åç«¯äº†ã€‚è€Œæ­£å¸¸çš„serviceæœ‰clusterIPï¼ŒæŸ¥è¯¢å®ƒçš„serviceNameï¼Œåªèƒ½è¿”å›å®ƒçš„è¿™ä¸ªClusterIP,è€Œæ— æ³•è¿”å›æ‰€æœ‰çš„åç«¯ã€‚

é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹æˆ‘ä»¬çŸ¥é“ï¼Œä½¿ç”¨headlessçš„æœ€å¤§çš„å¥½å¤„æ˜¯å¯ä»¥ç»™åç«¯ç»‘å®šä¸€ä¸ªdnsåŸŸåï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªåŸŸåæ¥è®¿é—®æŒ‡å®šçš„åç«¯ï¼ˆpodï¼‰ï¼Œå³ä½¿è¿™ä¸ªPodçš„ipå˜äº†ï¼Œå®ƒçš„åŸŸåä¸å˜ã€‚



å¯¹äºstafulSetè¿™ç±»æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œå³Podæ˜¯æœ‰å¯åŠ¨é¡ºåºçš„ï¼Œä¼šæ ¹æ®åå­—çš„é¡ºåºæ¥é¡ºåºå¯åŠ¨ã€‚
```
[root@node1 ~]# kubectl -n kubesphere-system get po |grep redis
redis-ha-server-0                           2/2     Running   0          13d
redis-ha-server-1                           2/2     Running   0          13d
redis-ha-server-2                           2/2     Running   0          13d
```

headless serviceæœ‰ä¸ªå¥½å¤„ï¼Œå¯ä»¥ç»™å®ƒçš„åç«¯ï¼ˆendpointï¼‰æ¯ä¸ªéƒ½åˆ†é…ä¸€ä¸ªdnsåŸŸåã€‚



3ï¼‰ å¦‚ä½•è§£æä¸€ä¸ªPodçš„DNS
```
[root@node1 ~]# kubectl -n kubesphere-system get po | grep redis
redis-ha-haproxy-8668585566-2jwkv           1/1     Running   0          11d
redis-ha-haproxy-8668585566-k7m6k           1/1     Running   0          11d
redis-ha-haproxy-8668585566-n5fvn           1/1     Running   0          11d
redis-ha-server-0                           2/2     Running   0          13d
redis-ha-server-1                           2/2     Running   0          13d
redis-ha-server-2                           2/2     Running   0          13d
```

```
[root@node1 ~]# dig redis-ha-server-1.kubesphere-system.svc.cluster.local @10.233.0.3
...
;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1
...
```
answerä¸º0ï¼Œä¸ºä»€ä¹ˆæ‰¾ä¸åˆ°è¿™ä¸ªpodçš„dns?


# å…³äºcorednsçš„è¸©å‘è®°å½•

1. å¯¹äºnodelocaldns çš„cmä¸­å®šä¹‰äº†è§£æçš„é¡ºåºï¼Œå…ˆæ˜¯å°†cluster.loalçš„å‘é€åˆ°corednsï¼ˆ169.254.25.10ï¼‰æ¥è§£æã€‚ä¸ç®¡æ˜¯corednsè¿˜æ˜¯nodelocaldnsï¼Œå¦‚æœä¸æ˜¯é›†ç¾¤å†…çš„åŸŸåï¼Œå®ƒæœ€ç»ˆä¼šç”¨ä¸»æœºçš„/etc/resolv.confä¸­çš„é…ç½®æ¥è§£å†³ã€‚å¯¹äºubuntu18ï¼Œåœ¨kubeletå¯åŠ¨çš„æ—¶å€™ä¼šå•ç‹¬æŒ‡å®šresolveæ–‡ä»¶ã€‚

```
 root@n1x2:~# cat /var/lib/kubelet/kubeadm-flags.env
KUBELET_KUBEADM_ARGS="--cgroup-driver=systemd --network-plugin=cni --pod-infra-container-image=kubesphere/pause:3.1 --resolv-conf=/run/systemd/resolve/resolv.conf"
```
è¯»çš„æ˜¯ /run/systemd/resolve/resolv.confï¼Œè€Œè¿™é‡Œé¢æœ‰å¾ˆdnsåœ°å€ï¼Œè™½ç„¶ç¬¬ä¸€ä¸ªæ˜¯ç§ç½‘å†…éƒ¨dnsèƒ½è§£æï¼Œä½†æ˜¯ç¬¬äºŒä¸ªæ˜¯1.2.4.8è¿™ä¸ªdnsï¼Œä¸€è‡´å¡ç€ä¸è§£æï¼Œå¯¼è‡´å®¹å™¨å†…çš„dnsè§£æå¤±è´¥ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶ä¸­çš„dnså…¨éƒ¨åˆ é™¤åªç•™ä¸€ä¸ªå†…ç½‘çš„dnsåœ°å€ï¼Œå°±æ­£å¸¸äº†ã€‚
